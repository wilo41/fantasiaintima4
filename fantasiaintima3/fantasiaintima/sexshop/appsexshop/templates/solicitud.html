
{% load static %}
{% include 'inc/header.html'%}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Pedidos</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    .producto-img { 
      max-width: 80px; 
      max-height: 80px; 
      object-fit: contain; 
    }
    .nav-tabs .nav-link {
      color: #495057;
      font-weight: 500;
    }
    .nav-tabs .nav-link.active {
      font-weight: bold;
      border-bottom: 3px solid #dc3545;;
    }
    .tab-content {
      padding: 20px 0;
    }
    .badge-estado {
      font-size: 0.9em;
      padding: 5px 10px;
    }
    .badge-espera {
      background-color: #ffc107;
      color: #212529;
    }
    .badge-aprobado {
      background-color: #28a745;
      color: white;
    }
    .badge-cancelado {
      background-color: #dc3545;
      color: white;
    }
    .acciones-btn {
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="container py-4">



    <h2 class="mb-4"><center> Gestión de Pedidos </center></h2>

    <!-- Flecha de regreso -->
    <a href="{% url 'Ladingpage' %}" class="btn btn-link mb-3" style="font-size: 1.3rem;">
      <i class="fas fa-arrow-left" style="color: #dc3545;"></i>
    </a>

    <!-- Pestañas -->
    <ul class="nav nav-tabs" id="pedidosTab" role="tablist">

      <li class="nav-item">
        <a class="nav-link active" id="espera-tab" data-toggle="tab" href="#espera" role="tab">
          <i class="fas fa-clock mr-1"></i> En espera
          <span class="badge badge-pill badge-warning ml-1">{{ pedidos_espera|length }}</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link" id="aprobados-tab" data-toggle="tab" href="#aprobados" role="tab">
          <i class="fas fa-check-circle mr-1"></i> Aceptados
          <span class="badge badge-pill badge-success ml-1">{{ pedidos_aprobados|length }}</span>
        </a>
      </li>

         <li class="nav-item">
     <a class="nav-link" id="enviados-tab" data-toggle="tab" href="#enviados" role="tab">
       <i class="fas fa-truck mr-1"></i> Enviados
       <span class="badge badge-pill badge-primary ml-1">{{ pedidos_enviados|length }}</span>
     </a>
   </li>
   
   <li class="nav-item">
     <a class="nav-link" id="entregados-tab" data-toggle="tab" href="#entregados" role="tab">
       <i class="fas fa-box-open mr-1"></i> Entregados
       <span class="badge badge-pill badge-dark ml-1">{{ pedidos_entregados|length }}</span>
     </a>
   </li>

      <li class="nav-item">
        <a class="nav-link" id="cancelados-tab" data-toggle="tab" href="#cancelados" role="tab">
          <i class="fas fa-times-circle mr-1"></i> Cancelados
          <span class="badge badge-pill badge-danger ml-1">{{ pedidos_cancelados|length }}</span>
        </a>
      </li>

      
    </ul>

    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content" id="pedidosTabContent">
      <!-- Pestaña En espera -->
      <div class="tab-pane fade show active" id="espera" role="tabpanel">
        {% if pedidos_espera %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="thead-light">
              <tr>
                <th>ID Pedido</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pedido in pedidos_espera %}
              <tr>
                <td>{{ pedido.codigo_pedido }}</td>
                <td>{{ pedido.cliente }}</td>
                <td>{{ pedido.fecha|date:"d/m/Y" }}</td>
                <td>{{ pedido.total }}</td>
                <td><span class="badge badge-estado badge-espera">En espera</span></td>
                <td class="acciones-btn">
                  <button class="btn btn-sm btn-info" style="background-color: #c0b7b8;" data-toggle="modal" data-target="#pedidoModal" 
                          onclick="mostrarDetallesPedido('{{ pedido.codigo_pedido }}')">
                      <i class="fas fa-eye" style="color: black;" ></i>
                  </button>
                  <button class="btn btn-sm btn-success aprobar-pedido" data-codigo="{{ pedido.codigo_pedido }}">
                      <i class="fas fa-check"></i> Aprobar
                  </button>
                  <button class="btn btn-sm btn-danger rechazar-pedido" data-codigo="{{ pedido.codigo_pedido }}">
                      <i class="fas fa-times"></i> Rechazar
                  </button>
              </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mt-3">
          No hay pedidos en espera de aprobación.
        </div>
        {% endif %}
      </div>

      <!-- Pestaña Aprobados -->
      <div class="tab-pane fade" id="aprobados" role="tabpanel">
        {% if pedidos_aprobados %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="thead-light">
              <tr>
                <th>ID Pedido</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pedido in pedidos_aprobados %}
              <tr>
                <td>{{ pedido.codigo_pedido }}</td>
                <td>{{ pedido.cliente }}</td>
                <td>{{ pedido.fecha|date:"d/m/Y H:i" }}</td>
                <td>${{ pedido.total|floatformat:2 }}</td>
                <td><span class="badge badge-estado badge-aprobado">Aprobado</span></td>
                <td class="acciones-btn">
                  <button class="btn btn-sm btn-info" style="background-color: #c0b7b8;" data-toggle="modal" data-target="#pedidoModal" 
                          onclick="mostrarDetallesPedido('{{ pedido.codigo_pedido }}')">
                    <i class="fas fa-eye" style="color: black;"></i>
                  </button>
                  <button class="btn btn-sm btn-warning enviar-pedido" data-codigo="{{ pedido.codigo_pedido }}">
                    <i class="fas fa-truck" ></i> Enviar
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mt-3">
          No hay pedidos aprobados.
        </div>
        {% endif %}
      </div>

      <!-- Pestaña Enviados -->
<div class="tab-pane fade" id="enviados" role="tabpanel">
  {% if pedidos_enviados %}
  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="thead-light">
        <tr>
          <th>ID Pedido</th>
          <th>Cliente</th>
          <th>Fecha</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for pedido in pedidos_enviados %}
        <tr>
          <td>{{ pedido.codigo_pedido }}</td>
          <td>{{ pedido.cliente }}</td>
          <td>{{ pedido.fecha|date:"d/m/Y H:i" }}</td>
          <td>${{ pedido.total|floatformat:2 }}</td>
          <td><span class="badge badge-estado badge-primary">Enviado</span></td>
          <td class="acciones-btn">

            <button class="btn btn-sm btn-info" style="background-color: #c0b7b8;" data-toggle="modal" data-target="#pedidoModal" 
                    onclick="mostrarDetallesPedido('{{ pedido.codigo_pedido }}')">
              <i class="fas fa-eye" style="color: black;"></i>
            </button>
            <button class="btn btn-sm btn-dark entregar-pedido" style="background-color: green;"  data-codigo="{{ pedido.codigo_pedido }}">
              <i class="fas fa-box-open"></i> Entregar
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info mt-3">
    No hay pedidos enviados.
  </div>
  {% endif %}
</div>

<!-- Pestaña Entregados -->
<div class="tab-pane fade" id="entregados" role="tabpanel">
  {% if pedidos_entregados %}
  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="thead-light">
        <tr>
          <th>ID Pedido</th>
          <th>Cliente</th>
          <th>Fecha</th>
          <th>Total</th>
          <th>Estado</th>
           <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for pedido in pedidos_entregados %}
        <tr>
          <td>{{ pedido.codigo_pedido }}</td>
          <td>{{ pedido.cliente }}</td>
          <td>{{ pedido.fecha|date:"d/m/Y H:i" }}</td>
          <td>${{ pedido.total|floatformat:2 }}</td>
          <td><span class="badge badge-estado badge-success">Entregado</span></td>
          <td class="acciones-btn">

            <button class="btn btn-sm btn-info" style="background-color: #c0b7b8;" data-toggle="modal" data-target="#pedidoModal" 
                    onclick="mostrarDetallesPedido('{{ pedido.codigo_pedido }}')">
              <i class="fas fa-eye" style="color: black;"></i>
            </button>

          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info mt-3">
    No hay pedidos entregados.
  </div>
  {% endif %}
</div>

      <!-- Pestaña Cancelados -->
      <div class="tab-pane fade" id="cancelados" role="tabpanel">
        {% if pedidos_cancelados %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="thead-light">
              <tr>
                <th>ID Pedido</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for pedido in pedidos_cancelados %}
              <tr>
                <td>{{ pedido.codigo_pedido }}</td>
                <td>{{ pedido.cliente }}</td>
                <td>{{ pedido.fecha|date:"d/m/Y H:i" }}</td>
                <td>${{ pedido.total|floatformat:2 }}</td>
                <td><span class="badge badge-estado badge-cancelado">Cancelado</span></td>
                <td>
                  <button class="btn btn-sm btn-info" style="background-color: #c0b7b8;" data-toggle="modal" data-target="#pedidoModal" 
                          onclick="mostrarDetallesPedido('{{ pedido.codigo_pedido }}')">
                    <i class="fas fa-eye" style="color: black;"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mt-3">
          No hay pedidos cancelados.
        </div>
        {% endif %}
      </div>


      


    </div>
  </div>

  <!-- Modal para detalles del pedido -->
  <div class="modal fade" id="pedidoModal" tabindex="-1" role="dialog" aria-labelledby="pedidoModalLabel">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="pedidoModalLabel">Detalles del Pedido</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="loadingSpinner" class="text-center py-4" style="display:none;">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p class="mt-2">Cargando detalles del pedido...</p>
          </div>

          <div id="pedidoContent" style="display:none;">
            <div class="row mb-3">
              <div class="col-md-6">
                <p><strong>ID Pedido:</strong> <span id="pedidoId"></span></p>
                <p><strong>Cliente:</strong> <span id="pedidoCliente"></span></p>
              </div>
              <div class="col-md-6">
                <p><strong>Fecha:</strong> <span id="pedidoFecha"></span></p>
                <p><strong>Total:</strong> $<span id="pedidoTotal"></span></p>
              </div>
            </div>

            <hr>

            <h5 class="mb-3">Productos</h5>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Total</th>
                    <th>Imagen</th>
                  </tr>
                </thead>
                <tbody id="pedidoArticulos">
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  

  <!-- scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Función para obtener el token CSRF de las cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Configura jQuery para añadir la cabecera en cada POST/PUT/DELETE
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });

function cambiarEstadoPedido(button, codigo, estado) {
    button.prop('disabled', true);
    const originalText = button.html();
    button.html('<i class="fas fa-spinner fa-spin"></i> Procesando...');

    $.ajax({
        url: `/cambiar-estado/${codigo}/`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ estado: estado }),
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    title: '¡Éxito!',
                    text: response.message,
                    icon: 'success'
                }).then(() => {
                    location.reload(); // Reload to reflect the new state
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: response.error || 'Error desconocido',
                    icon: 'error'
                });
                button.prop('disabled', false).html(originalText);
            }
        },
        error: function(xhr) {
            let errorMsg = 'Error de conexión';
            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || errorMsg;
            } catch (e) {}
            
            Swal.fire({
                title: 'Error',
                text: errorMsg,
                icon: 'error'
            });
            button.prop('disabled', false).html(originalText);
        }
    });
}

    // Uso en los botones
     $(document).on('click', '.aprobar-pedido, .rechazar-pedido, .enviar-pedido, .entregar-pedido', function() {
    const button = $(this);
    const codigo = button.data('codigo');
    let estado = '';
    let action = '';
    
    if (button.hasClass('aprobar-pedido')) {
        estado = 'Aprobado';
        action = 'aprobar';
    } else if (button.hasClass('rechazar-pedido')) {
        estado = 'Cancelado';
        action = 'rechazar';
    } else if (button.hasClass('enviar-pedido')) {
        estado = 'Enviado';
        action = 'enviar';
    } else if (button.hasClass('entregar-pedido')) {
        estado = 'Entregado';
        action = 'entregar';
    }

        
        
        Swal.fire({
        title: `¿${action.charAt(0).toUpperCase() + action.slice(1)} pedido?`,
        text: `¿Estás seguro de que deseas ${action} este pedido?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#f5365c',
        cancelButtonColor: 'black',
        confirmButtonText: `Sí, ${action}`,
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            cambiarEstadoPedido(button, codigo, estado);
        }
    });
});

    function mostrarDetallesPedido(codigoPedido) {
        // Mostrar spinner y ocultar contenido
        $('#loadingSpinner').show();
        $('#pedidoContent').hide();
        
        // Limpiar contenido anterior
        $('#pedidoId, #pedidoCliente, #pedidoFecha, #pedidoTotal').text('');
        $('#pedidoArticulos').empty();

        fetch(`/pedidos/${codigoPedido}/`)
            .then(response => {
                if (!response.ok) throw new Error('Pedido no encontrado');
                return response.json();
            })
            .then(data => {
                // Ocultar spinner y mostrar contenido
                $('#loadingSpinner').hide();
                $('#pedidoContent').show();

                // Llenar datos básicos
                $('#pedidoId').text(data.codigo_pedido || codigoPedido);
                $('#pedidoCliente').text(data.cliente || '');
                $('#pedidoFecha').text(data.fecha || '');
                $('#pedidoTotal').text(
                  new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                  }).format(data.total || 0)
                );

                // Llenar artículos
                const articulosList = $('#pedidoArticulos');
                if (data.articulos && data.articulos.length) {
                    data.articulos.forEach(art => {
                        articulosList.append(`
                            <tr>
                                <td>${art.nombre || ''}</td>
                                <td>${art.cantidad || ''}</td>
                                  <td>${new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 2,
                              maximumFractionDigits: 2
                          }).format(art.precio_unitario || 0)}</td>

                          <td>${new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 2,
                              maximumFractionDigits: 2
                          }).format(art.total || 0)}</td>
                                <td>${art.imagen ? `<img src="${art.imagen}" class="producto-img">` : ''}</td>
                            </tr>
                        `);
                    });
                } else {
                    articulosList.append('<tr><td colspan="5" class="text-center">No hay artículos</td></tr>');
                }
            })
            .catch(err => {
                console.error(err);
                $('#loadingSpinner').hide();
                Swal.fire(
                    'Error',
                    'Error al cargar los detalles del pedido.',
                    'error'
                );
            });
    }

    
  </script>
</body>
</html>